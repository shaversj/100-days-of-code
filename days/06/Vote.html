<!DOCTYPE html>

<html lang="en">
<!-- original template from here: http://voteapp.s3-website-us-east-1.amazonaws.com/ -->

<head>
    <meta charset="utf-8">
    <title>Vote for the best editor</title>
    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.15/c3.min.css">
    <!-- Custom styles for this template -->
    <link href="narrow.css" rel="stylesheet">
    <style>
        #graph {
            padding: 0 0 20px 0;
        }

        a {
            color: #FF9900;
        }

        .lead {
            color: #c6c6c6;
        }

        body {
            background-color: rgb(216, 216, 216);
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="jumbotron2">
            <h1>RPIT - Vote for the best editor</h1>
            <h4 class="center">Call and vote:</h4>
            <a href="tel:+18669165125">
                <h2 class="row">+1 866-916-5125</h2>
            </a>
            <h4 class="center">or Text your vote:</h4>
            <a href="tel:+12083141793">
                <h2 class="row">+1 208-314-1793</h2>
            </a>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div id="chart"></div>
            </div>
        </div>

    </div> <!-- /container -->
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.92.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.15/c3.min.js"></script>
    <script>
        AWS.config.region = 'us-east-1'; // Region
        AWS.config.credentials = new AWS.CognitoIdentityCredentials({
            IdentityPoolId: 'us-east-1:d2d449d2-fff0-483b-9533-f34790c491d2',
        });
        var dynamodb = new AWS.DynamoDB();
        var columns = [];
        var chart = c3.generate({
            bindto: '#chart',
            data: {
                type: 'donut',
                columns: columns
            },
            color: {
                pattern: ["#4b96ff",
                    "#becf1b",
                    "#505ee6",
                    "#409700",
                    "#7c26a8",
                    "#01ae40",
                    "#cf3abc",
                    "#a0d74f",
                    "#ff6ecc",
                    "#266000",
                    "#d3a3ff",
                    "#cdab00",
                    "#64428c",
                    "#c4cc7d",
                    "#a60056",
                    "#009566",
                    "#a51121",
                    "#81c2ff",
                    "#c74d00",
                    "#007cb4",
                    "#ff9954",
                    "#9ad3a8",
                    "#863e02",
                    "#ff9a8c",
                    "#9a5757"
                ]
            },
            tooltip: {
                format: {
                    title: function (d) {
                        return 'Votes'
                    },
                    value: function (value, ratio, id) {
                        return value;
                    }
                }
            },
            donut: {
                label: {
                    format: function (value, ratio, id) {
                        return value;
                    }
                }
            }
        });

        function getData() {
            dynamodb.scan({
                TableName: 'editor-votes'
            }, function (err, data) {
                if (err) {
                    console.log(err);
                    return null;
                } else {
                    // sort data since scan can be out of order
                    var items = data['Items'].sort(function (a, b) {
                        return a['name']['S'] < b['name']['S']
                    });
                    var new_columns = [];
                    for (var i in data['Items']) {
                        new_columns[i] = [
                            data['Items'][i]['name']['S'],
                            parseInt(data['Items'][i]['votes']['N'])
                        ];
                    }
                    var update = false;
                    if (columns.length > 0) {
                        for (var i in columns) {
                            if (new_columns[i][0] == columns[i][0] && new_columns[i][1] == columns[i][1]) {
                                continue
                            } else {
                                columns = new_columns;
                                update = true;
                            }
                        }
                    } else {
                        columns = new_columns;
                        update = true;
                    }
                    if (update) {
                        chart.load({
                            columns: new_columns
                        });
                    }
                }
            });
        }
        document.addEventListener("DOMContentLoaded", function (event) {
            getData();
            setInterval(getData, 5000);
        });
    </script>
</body>

</html>